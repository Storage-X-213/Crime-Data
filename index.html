<!DOCTYPE html>
<html>
<head>
	<!-- Code for the set up of the Mapbox API -->
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<script src='https://api.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css' rel='stylesheet' />
	<script src="jquery-3.4.1.min.js"></script>
	<script src="https://raw.githubusercontent.com/Storage-X-213/Storage-X-213.github.io/master/jquery-3.4.1.min.js"></script>
	<link rel="stylesheet" type="text/css" href="styleSheet.css"/>
	<!--<link rel="stylesheet" type="text/css" href="styleSheetOld.css"/>-->
    <script src="jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="jquery-ui.css">
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta charset="UTF-8">
</head>	

<body>

	<div id="meh">
	<label for="month" id="meh">Month: </label>
	<input type="text" id="month" name="month" class="monthPicker" />
	</div>
	<div id ="constabSelector">
	<select id="constabulary">
			  <option value="" disabled selected>Constabulary</option>
			  <option value="avon-and-somerset">Avon and Somerset</option>
			  <option value="bedfordshire">Bedfordshire</option>
			  <option value="btp">British Transport Police</option>
			  <option value="cambridgeshire">Cambridgeshire</option>
			  <option value="cheshire">Cheshire</option>
			  <option value="city-of-london">City of London</option>
			  <option value="cleveland">Cleveland</option>
			  <option value="cumbria">Cumbria</option>
			  <option value="derbyshire">Derbyshire</option>
			  <option value="devon-and-cornwall">Devon and Cornwall</option>
			  <option value="dorset">Dorset</option>
			  <option value="durham">Durham</option>
			  <option value="dyfed-powys">Dyfed Powys</option>
			  <option value="essex">Essex</option>
			  <option value="gloucestershire">Gloucestershire</option>
			  <option value="greater-manchester">Greater Manchester</option>
			  <option value="gwent">Gwent</option>
			  <option value="hampshire">Hampshire</option>
			  <option value="hertfordshire">Hertfordshire</option>
			  <option value="humberside">Humberside</option>
			  <option value="kent">Kent</option>
			  <option value="lancashire">Lancashire</option>
			  <option value="leicestershire">Leicestershire</option>
			  <option value="lincolnshire">Lincolnshire</option>
			  <option value="merseyside">Merseyside</option>
			  <option value="metropolitan">Metropolitan Police</option>
			  <option value="norfolk">Norfolk</option>
			  <option value="north-wales">North Wales</option>
			  <option value="north-yorkshire">North Yorkshire</option>
			  <option value="northhamptonshire">Northhamptonshire</option>
			  <option value="northern-ireland">Northern Island</option>
			  <option value="northumbria">Northumbria</option>
			  <option value="nottinghamshire">Nottinghamshire</option>
			  <option value="south-wales">South Wales</option>
			  <option value="south-yorkshire">South Yorkshire</option>
			  <option value="staffordshire">Staffordshire</option>
			  <option value="suffolk">Suffolk</option>
			  <option value="surrey">Surrey</option>
			  <option value="sussex">Sussex</option>
			  <option value="thames-valley">Thames Valley</option>
			  <option value="warwickshire">Warwickshire</option>
			  <option value="west-mercia">West Mercia</option>
			  <option value="west-midlands">West Midlands</option>
			  <option value="west-yorkshire">West Yorkshire</option>
			  <option value="wiltshire">Wiltshire</option>
			  
			  
	</select>
	</div>
	<input id="reloader" type="button" value="Reload"/>
	<input id="heatmapper" type="button" value="Heatmap"/>
	<div id='map'></div>
	<!--<div id='ui-datepicker-div'></div>-->
	<script>                           
	var month = "";
	var year = "";
	var dataUrl="https://raw.githubusercontent.com/Storage-X-213/Storage-X-213.github.io/master/2016-07/2016-07-suffolk-street.geojson"
	/*Code for the set up of the Mapbox API */
	mapboxgl.accessToken = "pk.eyJ1IjoibGVzcCIsImEiOiJjazA4NDNha3kwMWphM29wY2RkbnluZHJzIn0.dFz1M9lx7My6TbmDBJy6qA";
	var map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/mapbox/streets-v11',	
		center: [1.1482,52.0567],
		minZoom: 10,
		maxZoom: 17,
		zoom: 13,
		dragRotate: false,	
	});
	/*Code for the setup of the "month picker"*/
	$(document).ready(function()
	{  
		$('#reloader').click(function(){
		   reload();
		});
		$('#heatmapper').click(function(){
		   heatmap();
		});
		$(".monthPicker").datepicker({
			
			maxDate: new Date(2019,5,1),
			minDate: new Date(2016, 6, 1),
			changeMonth: true,	
			changeYear: true,
			showButtonPanel: true,

			onClose: function(dateText, inst, strUser) {
				month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
				year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
				$(this).val($.datepicker.formatDate('MM yy', new Date(year, month, 1)));

				
			}
		});

		$(".monthPicker").focus(function () {
			$(".ui-datepicker-calendar").hide();
			$("#ui-datepicker-div").position({
				my: "center top",
				at: "center bottom",
				of: $(this)
			});
		});
	});
	
	
	map.on('style.load', function() {
		init();
	});
	function reload(strUser){
		month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
		year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
		month=parseInt(month,10)+1;
		monthString=month.toString();
		if (monthString.length==1){monthString="0"+monthString;};
		if(map.getLayer("crimePoints")){
		map.removeLayer("crimePoints")};	
		if(map.getLayer("cluster-count")){		
		map.removeLayer("cluster-count")};
		if(map.getSource("crimeData")){
		map.removeSource("crimeData")};
		var e = document.getElementById("constabulary");
		var strUser = e.options[e.selectedIndex].value;
		dataUrl = "https://raw.githubusercontent.com/Storage-X-213/Storage-X-213.github.io/master/"+year+"-"+monthString+"/"+year+"-"+monthString+"-"+strUser+"-street.geojson";
		init();


	};
	function heatmap(strUser) {
		month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
		year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
				month=parseInt(month,10)+1;
		monthString=month.toString();
		if (monthString.length==1){monthString="0"+monthString;};
		var e = document.getElementById("constabulary");
		var strUser = e.options[e.selectedIndex].value;
		dataUrl = "https://raw.githubusercontent.com/Storage-X-213/Storage-X-213.github.io/master/"+year+"-"+monthString+"/"+year+"-"+monthString+"-"+strUser+"-street.geojson";

		if (month.length = 1) {
			month = "0" + month;
		}
		if (map.getLayer("crimePoints")) {
			map.removeLayer("crimePoints")
		}
		if (map.getLayer("cluster-count")) {
			map.removeLayer("cluster-count")
		}
		if (map.getSource("crimeData")) {
			map.removeSource("crimeData")
		}
		map.addSource("crimeData", {
			type: "geojson",
			data: dataUrl,
		});
		map.on('load', function() {
		map.addLayer({
		  "id": "crimeHeat",
		  "type": "heatmap",
		  "source": "crimeData",
		  "paint": {
			// Increase the heatmap intesity by zoom level
			// heatmap-intensity is a multiplier on top of heatmap-weight
			"heatmap-weight": [
			"interpolate",
			["linear"],
			["zoom"],
			0, 0,
			6, 1
			],
			"heatmap-intensity": [
			  "interpolate",
			  ["linear"],
			  ["zoom"],
			  0, 1,
			  18, 5
			],
			// Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
			// Begin color ramp at 0-stop with a 0-transparancy color
			// to create a blur-like effect.
			"heatmap-color": [
			  "interpolate",
			  ["linear"],
			  ["heatmap-density"],
			  0, "rgba(33,102,172,0)",
			  0.2, "rgb(103,169,207)",
			  0.4, "rgb(209,229,240)",
			  0.6, "rgb(253,219,199)",
			  0.8, "rgb(239,138,98)",
			  1, "rgb(178,24,43)"
			],
			// Adjust the heatmap radius by zoom level
			"heatmap-radius": [
			  "interpolate",
			  ["linear"],
			  ["zoom"],
			  0, 50,
			  20, 200
			],
		  }
		}, 'waterway-label');
	  });
	};
	function init(){
	
       map.addSource("crimeData", {
			type: "geojson",
			data: dataUrl,
			cluster: true,
			clusterMaxZoom: 2000, // Max zoom to cluster points on
			clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
			
		});
		map.addLayer({
			"id": "crimePoints",
			"type": "circle",
			"source": "crimeData",
			'paint': {
				//   * Green, 20px circles when point count is less than 50
				//   * Yellow, 30px circles when point count is between 50 and 300
				//   * Red, 40px circles when point count is between 300 and 1000
				//   * Dark Red, 50px circles when point count above 1000
				"circle-color": [
				"step",
				["get", "point_count"],
					"#38FE0D",
					50,
					"#FFFC32",
					300,
					"#FF0000",
					1000,
					"#C40000"
				],
				"circle-radius": [
					"step",
					["get", "point_count"],
						20,
						50,
						30,
						300,
						40,
						1000,
						50
					]
				}
			});
		
		map.addLayer({
			id: "cluster-count",
			type: "symbol",
			source: "crimeData",
			filter: ["has", "point_count"],
			layout: {
			"text-field": "{point_count_abbreviated}",
			"text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
			"text-size": 12
			}
		});
		
		map.on('click','crimePoints', function (e) {

			var features = map.queryRenderedFeatures(e.point, { layers: ['crimePoints'] });
			var clusterId = features[0].properties.cluster_id,
			point_count = features[0].properties.point_count,
			clusterSource = map.getSource('crimeData');

		  // Get all points under a cluster
			clusterSource.getClusterLeaves(clusterId, point_count, 0, function(err, aFeatures){
				var coordinates = aFeatures[0].geometry.coordinates.slice();
				var points= aFeatures;
				console.log(points);
				var i = 0;
				var description = "Crime(s) found are: ";
				while(i<point_count-1){var description = description + points[i].properties.description+", "; i++;};
				new mapboxgl.Popup()
					.setLngLat(coordinates)
					.setHTML(description)
					.addTo(map);
			});

		});	/*
		map.on('click', 'crimePoints', function (e) {
			var coordinates = e.features[0].geometry.coordinates.slice();
			var description = e.features[0].properties.description;
			
			 
			new mapboxgl.Popup()
			.setLngLat(coordinates)
			.setHTML(description)
			.addTo(map);
		});
		// Change the cursor to a pointer when the mouse is over the places layer.
		map.on('mouseenter', 'places', function () {
			map.getCanvas().style.cursor = 'pointer';
		});
		 
		// Change it back to a pointer when it leaves.
		map.on('mouseleave', 'places', function () {
			map.getCanvas().style.cursor = '';
		});*/
	};
	</script>
	
</body>
</html>
